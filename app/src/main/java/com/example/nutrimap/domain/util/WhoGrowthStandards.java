package com.example.nutrimap.domain.util;

public class WhoGrowthStandards {

    // LMS Parameters for Boys (Weight-for-Height)
    // Format: { Height, L, M, S }
    private static final double[][] BOYS_WFH = {
            {45.0, -0.3521, 2.441, 0.09182},
            {46.0, -0.3521, 2.528, 0.09153},
            {47.0, -0.3521, 2.618, 0.09124},
            {48.0, -0.3521, 2.711, 0.09094},
            {49.0, -0.3521, 2.807, 0.09065},
            {50.0, -0.3521, 2.906, 0.09036},
            {51.0, -0.3521, 3.010, 0.09007},
            {52.0, -0.3521, 3.117, 0.08977},
            {53.0, -0.3521, 3.227, 0.08948},
            {54.0, -0.3521, 3.341, 0.08919},
            {55.0, -0.3521, 3.459, 0.08889},
            {56.0, -0.3521, 3.581, 0.08860},
            {57.0, -0.3521, 3.708, 0.08831},
            {58.0, -0.3521, 3.840, 0.08802},
            {59.0, -0.3521, 3.976, 0.08773},
            {60.0, -0.3521, 4.117, 0.08744},
            {61.0, -0.3521, 4.263, 0.08716},
            {62.0, -0.3521, 4.413, 0.08687},
            {63.0, -0.3521, 4.565, 0.08659},
            {64.0, -0.3521, 4.720, 0.08631},
            {65.0, -0.3521, 4.877, 0.08603},
            {66.0, -0.3521, 5.037, 0.08576},
            {67.0, -0.3521, 5.199, 0.08549},
            {68.0, -0.3521, 5.364, 0.08522},
            {69.0, -0.3521, 5.532, 0.08495},
            {70.0, -0.3521, 5.703, 0.08469},
            {71.0, -0.3521, 5.877, 0.08443},
            {72.0, -0.3521, 6.053, 0.08418},
            {73.0, -0.3521, 6.231, 0.08393},
            {74.0, -0.3521, 6.411, 0.08369},
            {75.0, -0.3521, 6.593, 0.08345},
            {76.0, -0.3521, 6.777, 0.08321},
            {77.0, -0.3521, 6.963, 0.08298},
            {78.0, -0.3521, 7.149, 0.08276},
            {79.0, -0.3521, 7.337, 0.08254},
            {80.0, -0.3521, 7.527, 0.08232},
            {81.0, -0.3521, 7.719, 0.08211},
            {82.0, -0.3521, 7.913, 0.08190},
            {83.0, -0.3521, 8.109, 0.08170},
            {84.0, -0.3521, 8.308, 0.08150},
            {85.0, -0.3521, 8.509, 0.08131},
            {86.0, -0.3521, 8.714, 0.08112},
            {87.0, -0.3521, 8.922, 0.08094},
            {88.0, -0.3521, 9.134, 0.08076},
            {89.0, -0.3521, 9.350, 0.08059},
            {90.0, -0.3521, 9.570, 0.08042},
            {91.0, -0.3521, 9.795, 0.08025},
            {92.0, -0.3521, 10.024, 0.08009},
            {93.0, -0.3521, 10.258, 0.07993},
            {94.0, -0.3521, 10.496, 0.07978},
            {95.0, -0.3521, 10.739, 0.07963},
            {96.0, -0.3521, 10.987, 0.07948},
            {97.0, -0.3521, 11.240, 0.07934},
            {98.0, -0.3521, 11.498, 0.07920},
            {99.0, -0.3521, 11.761, 0.07907},
            {100.0, -0.3521, 12.029, 0.07894},
            {101.0, -0.3521, 12.302, 0.07881},
            {102.0, -0.3521, 12.580, 0.07869},
            {103.0, -0.3521, 12.864, 0.07857},
            {104.0, -0.3521, 13.153, 0.07845},
            {105.0, -0.3521, 13.448, 0.07834},
            {106.0, -0.3521, 13.749, 0.07823},
            {107.0, -0.3521, 14.056, 0.07813},
            {108.0, -0.3521, 14.369, 0.07803},
            {109.0, -0.3521, 14.688, 0.07793},
            {110.0, -0.3521, 15.014, 0.07783},
            {111.0, -0.3521, 15.346, 0.07774},
            {112.0, -0.3521, 15.685, 0.07765},
            {113.0, -0.3521, 16.030, 0.07757},
            {114.0, -0.3521, 16.382, 0.07749},
            {115.0, -0.3521, 16.741, 0.07741},
            {116.0, -0.3521, 17.107, 0.07733},
            {117.0, -0.3521, 17.480, 0.07726},
            {118.0, -0.3521, 17.860, 0.07719},
            {119.0, -0.3521, 18.247, 0.07713},
            {120.0, -0.3521, 18.641, 0.07707}
    };

    // LMS Parameters for Girls (Weight-for-Height)
    // Format: { Height, L, M, S }
    private static final double[][] GIRLS_WFH = {
            {45.0, -0.3833, 2.343, 0.09029},
            {46.0, -0.3833, 2.421, 0.09003},
            {47.0, -0.3833, 2.503, 0.08977},
            {48.0, -0.3833, 2.588, 0.08951},
            {49.0, -0.3833, 2.676, 0.08925},
            {50.0, -0.3833, 2.768, 0.08899},
            {51.0, -0.3833, 2.863, 0.08873},
            {52.0, -0.3833, 2.962, 0.08847},
            {53.0, -0.3833, 3.064, 0.08821},
            {54.0, -0.3833, 3.170, 0.08795},
            {55.0, -0.3833, 3.281, 0.08769},
            {56.0, -0.3833, 3.396, 0.08743},
            {57.0, -0.3833, 3.515, 0.08717},
            {58.0, -0.3833, 3.638, 0.08691},
            {59.0, -0.3833, 3.766, 0.08665},
            {60.0, -0.3833, 3.899, 0.08639},
            {61.0, -0.3833, 4.036, 0.08614},
            {62.0, -0.3833, 4.177, 0.08589},
            {63.0, -0.3833, 4.321, 0.08564},
            {64.0, -0.3833, 4.469, 0.08539},
            {65.0, -0.3833, 4.620, 0.08515},
            {66.0, -0.3833, 4.773, 0.08491},
            {67.0, -0.3833, 4.929, 0.08468},
            {68.0, -0.3833, 5.088, 0.08445},
            {69.0, -0.3833, 5.251, 0.08422},
            {70.0, -0.3833, 5.418, 0.08400},
            {71.0, -0.3833, 5.588, 0.08379},
            {72.0, -0.3833, 5.762, 0.08358},
            {73.0, -0.3833, 5.939, 0.08338},
            {74.0, -0.3833, 6.120, 0.08318},
            {75.0, -0.3833, 6.303, 0.08299},
            {76.0, -0.3833, 6.490, 0.08280},
            {77.0, -0.3833, 6.679, 0.08262},
            {78.0, -0.3833, 6.871, 0.08245},
            {79.0, -0.3833, 7.066, 0.08228},
            {80.0, -0.3833, 7.264, 0.08211},
            {81.0, -0.3833, 7.464, 0.08195},
            {82.0, -0.3833, 7.667, 0.08180},
            {83.0, -0.3833, 7.873, 0.08165},
            {84.0, -0.3833, 8.082, 0.08151},
            {85.0, -0.3833, 8.293, 0.08137},
            {86.0, -0.3833, 8.508, 0.08124},
            {87.0, -0.3833, 8.725, 0.08111},
            {88.0, -0.3833, 8.946, 0.08099},
            {89.0, -0.3833, 9.170, 0.08088},
            {90.0, -0.3833, 9.397, 0.08076},
            {91.0, -0.3833, 9.628, 0.08066},
            {92.0, -0.3833, 9.862, 0.08055},
            {93.0, -0.3833, 10.099, 0.08046},
            {94.0, -0.3833, 10.340, 0.08036},
            {95.0, -0.3833, 10.584, 0.08027},
            {96.0, -0.3833, 10.832, 0.08019},
            {97.0, -0.3833, 11.083, 0.08011},
            {98.0, -0.3833, 11.338, 0.08003},
            {99.0, -0.3833, 11.597, 0.07996},
            {100.0, -0.3833, 11.859, 0.07989},
            {101.0, -0.3833, 12.125, 0.07983},
            {102.0, -0.3833, 12.394, 0.07977},
            {103.0, -0.3833, 12.668, 0.07971},
            {104.0, -0.3833, 12.946, 0.07966},
            {105.0, -0.3833, 13.228, 0.07961},
            {106.0, -0.3833, 13.515, 0.07957},
            {107.0, -0.3833, 13.806, 0.07953},
            {108.0, -0.3833, 14.102, 0.07949},
            {109.0, -0.3833, 14.402, 0.07946},
            {110.0, -0.3833, 14.707, 0.07943},
            {111.0, -0.3833, 15.018, 0.07941},
            {112.0, -0.3833, 15.334, 0.07939},
            {113.0, -0.3833, 15.656, 0.07937},
            {114.0, -0.3833, 15.983, 0.07936},
            {115.0, -0.3833, 16.316, 0.07935},
            {116.0, -0.3833, 16.655, 0.07934},
            {117.0, -0.3833, 17.000, 0.07934},
            {118.0, -0.3833, 17.352, 0.07934},
            {119.0, -0.3833, 17.710, 0.07935},
            {120.0, -0.3833, 18.075, 0.07936}
    };

    /**
     * Compute the WHO Weight-for-Height Z-score using the LMS method.
     * Formula:
     *   z = ((X/M)^L - 1) / (L*S)   if L != 0
     *   z = ln(X/M) / S             if L == 0
     *
     * @param weightKg The child's weight in kg.
     * @param heightCm The child's height in cm.
     * @param gender   The child's gender ("Male" or "Female").
     * @return The z-score, or Double.NaN if height is out of range (45-120cm).
     */
    public static double computeWhzZScore(double weightKg, double heightCm, String gender) {
        if (heightCm < 45.0 || heightCm > 120.0) {
            return Double.NaN;
        }

        double[][] table = isMale(gender) ? BOYS_WFH : GIRLS_WFH;
        
        // Find interpolation parameters
        LMS lms = getInterpolatedLMS(table, heightCm);
        
        if (lms == null) return Double.NaN;
        
        double L = lms.l;
        double M = lms.m;
        double S = lms.s;
        double X = weightKg;
        
        double z;
        if (Math.abs(L) < 0.0000001) {
            z = Math.log(X / M) / S;
        } else {
            z = (Math.pow(X / M, L) - 1) / (L * S);
        }
        
        return z;
    }

    private static boolean isMale(String gender) {
        return gender != null && (gender.equalsIgnoreCase("Male") || gender.equalsIgnoreCase("M"));
    }
    
    // Structure to hold L, M, S values
    private static class LMS {
        double l, m, s;
        LMS(double l, double m, double s) {
            this.l = l;
            this.m = m;
            this.s = s;
        }
    }
    
    // Linear interpolation for L, M, S based on height
    private static LMS getInterpolatedLMS(double[][] table, double height) {
        // Table format: { H, L, M, S } - sorted by H
        // We know the table starts at 45.0 and increments by 1.0.
        // We can use index calculation for speed, or linear search.
        // Index = (int) (height - 45.0)
        
        int index = (int) Math.floor(height - 45.0);
        
        // Safety check boundaries
        if (index < 0) index = 0;
        if (index >= table.length - 1) {
             // If exactly 120.0 or slightly more (but handled by main check), return the last entry
             if (height >= table[table.length-1][0]) {
                 double[] row = table[table.length-1];
                 return new LMS(row[1], row[2], row[3]);
             }
             index = table.length - 2;
        }

        double[] row1 = table[index];
        double[] row2 = table[index + 1];
        
        double h1 = row1[0];
        double h2 = row2[0];
        
        double fraction = (height - h1) / (h2 - h1);
        
        // Lerp L, M, S
        double l = row1[1] + fraction * (row2[1] - row1[1]);
        double m = row1[2] + fraction * (row2[2] - row1[2]);
        double s = row1[3] + fraction * (row2[3] - row1[3]);
        
        return new LMS(l, m, s);
    }
}
